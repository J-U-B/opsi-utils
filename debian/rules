#!/usr/bin/make -f

build: build-arch build-indep

build-arch: build23-stamp build24-stamp build-stamp

build24-stamp:
	rm -f build24-stamp
	rm -Rf debian/tmp24 || true
	mkdir debian/tmp24
	for i in opsi-package-manager opsi-admin opsi-newprod opsi-makeproductfile opsiinst opsiuninst opsi-convert; do cat $$i | sed 's/#!\/usr\/bin\/python/#!\/usr\/bin\/python2.4/' > debian/tmp24/$$i; done
	touch build24-stamp

build23-stamp:
	rm -f build23-stamp
	rm -Rf debian/tmp23 || true
	mkdir debian/tmp23
	for i in opsi-package-manager opsi-admin opsi-newprod opsi-makeproductfile opsiinst opsiuninst opsi-convert; do cat $$i | sed 's/#!\/usr\/bin\/python/#!\/usr\/bin\/python2.3/' > debian/tmp23/$$i; done
	touch build23-stamp

build-stamp:

build-indep: build-indep-stamp

build-indep-stamp:
	# Make sure we are in the correct directory
	dh_testdir
	# Ensure that package is built as root
	dh_testroot
	# Clean up package build directories
	dh_clean -k
	# Create subdirectories in package build directories
	dh_installdirs
	rm -f build-indep-stamp
	msgfmt -o gettext/opsi_newprod_de.mo gettext/opsi_newprod_de.po
	touch build-indep-stamp

clean:
	rm -f *-stamp
	rm -Rf debian/tmp23 || true
	rm -Rf debian/tmp24 || true

binary: binary-arch binary-indep

binary-arch: build-arch binary23-stamp binary24-stamp binary-stamp

binary23-stamp:
	mkdir -p debian/opsi-utils-python2.3/usr/bin
	mkdir -p debian/opsi-utils-python2.3/usr/share/locale/de/LC_MESSAGES
	install -m 0640 gettext/opsi_newprod_de.mo debian/opsi-utils-python2.3/usr/share/locale/de/LC_MESSAGES/opsi_newprod.mo
	install -m 0750 -g opsiadmin debian/tmp23/opsi-admin debian/opsi-utils-python2.3/usr/bin/
	install -m 0755 debian/tmp23/opsi-newprod debian/opsi-utils-python2.3/usr/bin/
	install -m 0755 debian/tmp23/opsi-makeproductfile debian/opsi-utils-python2.3/usr/bin/
	install -m 0755 debian/tmp23/opsiinst debian/opsi-utils-python2.3/usr/bin/
	install -m 0755 debian/tmp23/opsiuninst debian/opsi-utils-python2.3/usr/bin/
	install -m 0755 debian/tmp23/opsi-package-manager debian/opsi-utils-python2.3/usr/bin/
	install -m 0755 debian/tmp23/opsi-convert debian/opsi-utils-python2.3/usr/bin/opsi-convert
	install -m 0755 opsi-makeproductfilev2 debian/opsi-utils-python2.3/usr/bin/
	install -m 0755 opsiinstv2 debian/opsi-utils-python2.3/usr/bin/
	install -m 0755 opsi-winipatch debian/opsi-utils-python2.3/usr/bin/winipatch
	install -m 0755 sysbackup debian/opsi-utils-python2.3/usr/bin/sysbackup
	rm -Rf debian/tmp23 || true

binary24-stamp:
	mkdir -p debian/opsi-utils-python2.4/usr/bin
	mkdir -p debian/opsi-utils-python2.4/usr/share/locale/de/LC_MESSAGES
	install -m 0640 gettext/opsi_newprod_de.mo debian/opsi-utils-python2.4/usr/share/locale/de/LC_MESSAGES/opsi_newprod.mo
	install -m 0750 -g opsiadmin debian/tmp24/opsi-admin debian/opsi-utils-python2.4/usr/bin/
	install -m 0755 debian/tmp24/opsi-newprod debian/opsi-utils-python2.4/usr/bin/
	install -m 0755 debian/tmp24/opsi-makeproductfile debian/opsi-utils-python2.4/usr/bin/
	install -m 0755 debian/tmp24/opsiinst debian/opsi-utils-python2.4/usr/bin/
	install -m 0755 debian/tmp24/opsiuninst debian/opsi-utils-python2.4/usr/bin/
	install -m 0755 debian/tmp24/opsi-package-manager debian/opsi-utils-python2.4/usr/bin/
	install -m 0755 debian/tmp24/opsi-convert debian/opsi-utils-python2.4/usr/bin/opsi-convert
	install -m 0755 opsi-makeproductfilev2 debian/opsi-utils-python2.4/usr/bin/
	install -m 0755 opsiinstv2 debian/opsi-utils-python2.4/usr/bin/
	install -m 0755 opsi-winipatch debian/opsi-utils-python2.4/usr/bin/winipatch
	install -m 0755 sysbackup debian/opsi-utils-python2.4/usr/bin/sysbackup
	rm -Rf debian/tmp24 || true

binary-stamp:
	mkdir -p debian/opsi-utils/usr/bin
	mkdir -p debian/opsi-utils/usr/share/locale/de/LC_MESSAGES
	install -m 0640 gettext/opsi_newprod_de.mo debian/opsi-utils/usr/share/locale/de/LC_MESSAGES/opsi_newprod.mo
	install -m 0750 -g opsiadmin opsi-admin debian/opsi-utils/usr/bin/
	install -m 0755 opsi-newprod debian/opsi-utils/usr/bin/
	install -m 0755 opsi-makeproductfile debian/opsi-utils/usr/bin/
	install -m 0755 opsiinst debian/opsi-utils/usr/bin/
	install -m 0755 opsiuninst debian/opsi-utils/usr/bin/
	install -m 0755 opsi-package-manager debian/opsi-utils/usr/bin/
	install -m 0755 opsi-convert debian/opsi-utils/usr/bin/opsi-convert
	install -m 0755 opsi-makeproductfilev2 debian/opsi-utils/usr/bin/
	install -m 0755 opsiinstv2 debian/opsi-utils/usr/bin/
	install -m 0755 opsi-winipatch debian/opsi-utils/usr/bin/winipatch
	install -m 0755 sysbackup debian/opsi-utils/usr/bin/sysbackup
	
binary-indep: build-indep binary-indep-stamp

binary-indep-stamp:
	# Create symlinks
	dh_link -A usr/bin/opsi-makeproductfile usr/bin/makeproductfile
	dh_link -A usr/bin/opsi-makeproductfilev2 usr/bin/makeproductfilev2
	dh_link -A usr/bin/opsi-newprod usr/bin/newprod
	dh_link -A usr/bin/winipatch usr/bin/opsi-winipatch
	# Install changelogs into package build directories
	dh_installchangelogs
	# Fix permissions of files in package build directories
	dh_fixperms
	# Install files into the DEBIAN directory
	dh_installdeb
	# Generate and install control file
	dh_gencontrol -i
	# Install files used by debconf in package build directories
	dh_installdebconf
	# Generate DEBIAN/md5sums file
	dh_md5sums
	# Build debian packages
	dh_builddeb

.PHONY: clean build build-arch build-indep binary binary-arch binary-indep
